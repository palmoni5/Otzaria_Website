name: Deploy to VPS with Caching

on:
  push:
    branches:
      - master

jobs:
  # ×©×œ×‘ 1: ×‘×“×™×§×” ×‘-GitHub (××”×™×¨ ×™×•×ª×¨ ×‘×–×›×•×ª Cache)
  build-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20 with Cache
        uses: actions/setup-node@v4
        with:
          node-version: '20' # ×¢×•×“×›×Ÿ ×œ-20
          cache: 'npm'       # ×–×• ×”×©×•×¨×” ×©××•×¡×™×¤×” ××ª ×”×§×¡× - ×©×•××¨×ª ××ª ×”×”×ª×§× ×•×ª ×‘×–×™×›×¨×•×Ÿ

      - name: Install Dependencies
        run: npm ci # ×™×¨×•×¥ ×”×¨×‘×” ×™×•×ª×¨ ××”×¨ ×‘×–×›×•×ª ×”-cache

      - name: Try to Build
        run: npm run build

  # ×©×œ×‘ 2: ×¤×¨×™×¡×” ×œ×©×¨×ª (××•×¤×˜×™××™×–×¦×™×” ×‘×”×¢×ª×§×ª ×§×‘×¦×™×)
  deploy:
    needs: build-check
    runs-on: ubuntu-latest
    steps:
      - name: Deploy using SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT }}
          timeout: 60s
          command_timeout: 30m
            set -e

            APP_DIR="/var/www/otzaria-web"
            TEMP_DIR="/var/www/otzaria-web-temp"

            echo "ğŸš€ Starting Optimized Deployment..."


            rm -rf $TEMP_DIR
            mkdir -p $TEMP_DIR

            echo "ğŸ“‹ Copying files (skipping heavy node_modules)..."
            rsync -a --exclude 'node_modules' --exclude '.git' $APP_DIR/ $TEMP_DIR/
            
            cd $TEMP_DIR

            echo "ğŸ“¥ Pulling latest code..."
            git init
            git remote add origin https://github.com/${{ github.repository }}.git
            git fetch --depth 1 origin master
            git reset --hard origin/master

            echo "ğŸ“¦ Installing dependencies..."
            npm ci

            echo "ğŸ›  Building project..."
            npm run build

            echo "âœ… Build successful. Swapping folders..."
            
            rsync -a --delete $TEMP_DIR/ $APP_DIR/

            rm -rf $TEMP_DIR

            echo "ğŸ”„ Reloading PM2..."
            cd $APP_DIR
            pm2 reload otzaria-web || pm2 restart otzaria-web

            echo "ğŸ‰ Deployment Finished Successfully!"